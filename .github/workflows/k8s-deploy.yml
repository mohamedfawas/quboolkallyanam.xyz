name: K8s Deploy 

on:
  workflow_dispatch:
    inputs:
      deploy_gateway:
        description: '‚òê Deploy Gateway'
        type: boolean
        default: false
      deploy_auth:
        description: '‚òê Deploy Auth'
        type: boolean
        default: false
      deploy_user:
        description: '‚òê Deploy User'
        type: boolean
        default: false
      deploy_chat:
        description: '‚òê Deploy Chat'
        type: boolean
        default: false
      deploy_payment:
        description: '‚òê Deploy Payment'
        type: boolean
        default: false
      deploy_notification:
        description: '‚òê Deploy Notification'
        type: boolean
        default: false
      deploy_all:
        description: 'üöÄ Deploy ALL services'
        type: boolean
        default: false
      image_tag:
        description: 'Image tag (e.g., "sha-abc123" or leave empty for current commit)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: k8s-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ vars.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.W_POOL }}/providers/${{ vars.W_PROVIDER }}
          service_account: ${{ vars.CI_SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER }} \
            --region ${{ vars.GKE_REGION }} \
            --project ${{ vars.PROJECT_ID }}

      - name: Determine services to deploy
        id: services
        run: |
          SERVICES=""
          
          if [[ "${{ github.event.inputs.deploy_all }}" == "true" ]]; then
            SERVICES="gateway auth user chat payment notification"
            echo "üöÄ Deploying ALL services"
          else
            [[ "${{ github.event.inputs.deploy_gateway }}" == "true" ]] && SERVICES+="gateway "
            [[ "${{ github.event.inputs.deploy_auth }}" == "true" ]] && SERVICES+="auth "
            [[ "${{ github.event.inputs.deploy_user }}" == "true" ]] && SERVICES+="user "
            [[ "${{ github.event.inputs.deploy_chat }}" == "true" ]] && SERVICES+="chat "
            [[ "${{ github.event.inputs.deploy_payment }}" == "true" ]] && SERVICES+="payment "
            [[ "${{ github.event.inputs.deploy_notification }}" == "true" ]] && SERVICES+="notification "
            
            SERVICES="${SERVICES% }"
            
            if [[ -z "$SERVICES" ]]; then
              echo "‚ùå No services selected! Please check at least one service."
              exit 1
            fi
            
            echo "üì¶ Deploying selected services: $SERVICES"
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

      - name: Ensure namespace exists
        run: |
          kubectl create namespace ${{ vars.NS }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply ServiceAccounts
        run: |
          kubectl apply -f deploy/k8s/ksa-workload.yaml
          kubectl apply -f deploy/k8s/ksa-media-signer.yaml || true

      - name: Sync ConfigMaps
        env:
          NS: ${{ vars.NS }}
          ENVIRONMENT: ${{ vars.ENVIRONMENT }}
          DEFAULT_TIMEZONE: ${{ vars.DEFAULT_TIMEZONE }}
          GATEWAY_HTTP_PORT: ${{ vars.GATEWAY_HTTP_PORT }}
          GATEWAY_BASE_URL: ${{ vars.GATEWAY_BASE_URL }}
          POSTGRES_HOST: ${{ vars.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_SSLMODE: ${{ vars.POSTGRES_SSLMODE }}
          POSTGRES_TIMEZONE: ${{ vars.POSTGRES_TIMEZONE }}
          AUTH_POSTGRES_DBNAME: ${{ vars.AUTH_POSTGRES_DBNAME }}
          USER_POSTGRES_DBNAME: ${{ vars.USER_POSTGRES_DBNAME }}
          CHAT_POSTGRES_DBNAME: ${{ vars.CHAT_POSTGRES_DBNAME }}
          PAYMENT_POSTGRES_DBNAME: ${{ vars.PAYMENT_POSTGRES_DBNAME }}
          REDIS_HOST: ${{ vars.REDIS_HOST }}
          REDIS_PORT: ${{ vars.REDIS_PORT }}
          RABBITMQ_EXCHANGE_NAME: ${{ vars.RABBITMQ_EXCHANGE_NAME }}
          PUBSUB_PROJECT_ID: ${{ vars.PUBSUB_PROJECT_ID }}
          JWT_ACCESS_TOKEN_MINUTES: ${{ vars.JWT_ACCESS_TOKEN_MINUTES }}
          JWT_REFRESH_TOKEN_DAYS: ${{ vars.JWT_REFRESH_TOKEN_DAYS }}
          JWT_ISSUER: ${{ vars.JWT_ISSUER }}
          AUTH_GRPC_PORT: ${{ vars.AUTH_GRPC_PORT }}
          USER_GRPC_PORT: ${{ vars.USER_GRPC_PORT }}
          CHAT_GRPC_PORT: ${{ vars.CHAT_GRPC_PORT }}
          PAYMENT_GRPC_PORT: ${{ vars.PAYMENT_GRPC_PORT }}
          MONGODB_TIMEOUT: ${{ vars.MONGODB_TIMEOUT }}
          CHAT_MONGODB_DATABASE: ${{ vars.CHAT_MONGODB_DATABASE }}
          AUTH_AUTH_PENDING_REGISTRATION_EXPIRY_HOURS: ${{ vars.AUTH_AUTH_PENDING_REGISTRATION_EXPIRY_HOURS }}
          AUTH_AUTH_OTP_EXPIRY_MINUTES: ${{ vars.AUTH_AUTH_OTP_EXPIRY_MINUTES }}
          AUTH_REDIS_DB: ${{ vars.AUTH_REDIS_DB }}
          USER_MEDIA_STORAGE_BUCKET: ${{ vars.USER_MEDIA_STORAGE_BUCKET }}
          USER_MEDIA_STORAGE_URL_EXPIRY: ${{ vars.USER_MEDIA_STORAGE_URL_EXPIRY }}
          USER_MEDIA_STORAGE_SIGNER_EMAIL: ${{ vars.USER_MEDIA_STORAGE_SIGNER_EMAIL }}
          NOTIFICATION_EMAIL_SMTP_HOST: ${{ vars.NOTIFICATION_EMAIL_SMTP_HOST }}
          NOTIFICATION_EMAIL_SMTP_PORT: ${{ vars.NOTIFICATION_EMAIL_SMTP_PORT }}
          NOTIFICATION_EMAIL_FROM_EMAIL: ${{ vars.NOTIFICATION_EMAIL_FROM_EMAIL }}
          NOTIFICATION_EMAIL_FROM_NAME: ${{ vars.NOTIFICATION_EMAIL_FROM_NAME }}
        run: |
          set -euo pipefail
          
          kubectl -n "$NS" create configmap shared-config \
            --from-literal=DEFAULT_TIMEZONE="$DEFAULT_TIMEZONE" \
            --from-literal=ENVIRONMENT="$ENVIRONMENT" \
            --from-literal=POSTGRES_HOST="$POSTGRES_HOST" \
            --from-literal=POSTGRES_PORT="$POSTGRES_PORT" \
            --from-literal=POSTGRES_USER="$POSTGRES_USER" \
            --from-literal=POSTGRES_SSLMODE="$POSTGRES_SSLMODE" \
            --from-literal=POSTGRES_TIMEZONE="$POSTGRES_TIMEZONE" \
            --from-literal=RABBITMQ_EXCHANGE_NAME="$RABBITMQ_EXCHANGE_NAME" \
            --from-literal=PUBSUB_PROJECT_ID="$PUBSUB_PROJECT_ID" \
            --from-literal=REDIS_HOST="$REDIS_HOST" \
            --from-literal=REDIS_PORT="$REDIS_PORT" \
            --from-literal=MONGODB_TIMEOUT="$MONGODB_TIMEOUT" \
            --from-literal=AUTH_GRPC_PORT="$AUTH_GRPC_PORT" \
            --from-literal=USER_GRPC_PORT="$USER_GRPC_PORT" \
            --from-literal=CHAT_GRPC_PORT="$CHAT_GRPC_PORT" \
            --from-literal=PAYMENT_GRPC_PORT="$PAYMENT_GRPC_PORT" \
            --from-literal=JWT_ACCESS_TOKEN_MINUTES="$JWT_ACCESS_TOKEN_MINUTES" \
            --from-literal=JWT_REFRESH_TOKEN_DAYS="$JWT_REFRESH_TOKEN_DAYS" \
            --from-literal=JWT_ISSUER="$JWT_ISSUER" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create configmap gateway-config \
            --from-literal=GATEWAY_HTTP_PORT="$GATEWAY_HTTP_PORT" \
            --from-literal=GATEWAY_BASE_URL="$GATEWAY_BASE_URL" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create configmap auth-config \
            --from-literal=AUTH_POSTGRES_DBNAME="$AUTH_POSTGRES_DBNAME" \
            --from-literal=AUTH_REDIS_DB="$AUTH_REDIS_DB" \
            --from-literal=AUTH_AUTH_PENDING_REGISTRATION_EXPIRY_HOURS="$AUTH_AUTH_PENDING_REGISTRATION_EXPIRY_HOURS" \
            --from-literal=AUTH_AUTH_OTP_EXPIRY_MINUTES="$AUTH_AUTH_OTP_EXPIRY_MINUTES" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create configmap user-config \
            --from-literal=USER_POSTGRES_DBNAME="$USER_POSTGRES_DBNAME" \
            --from-literal=USER_MEDIA_STORAGE_BUCKET="$USER_MEDIA_STORAGE_BUCKET" \
            --from-literal=USER_MEDIA_STORAGE_URL_EXPIRY="$USER_MEDIA_STORAGE_URL_EXPIRY" \
            --from-literal=USER_MEDIA_STORAGE_SIGNER_EMAIL="$USER_MEDIA_STORAGE_SIGNER_EMAIL" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create configmap chat-config \
            --from-literal=CHAT_POSTGRES_DBNAME="$CHAT_POSTGRES_DBNAME" \
            --from-literal=CHAT_MONGODB_DATABASE="$CHAT_MONGODB_DATABASE" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create configmap payment-config \
            --from-literal=PAYMENT_POSTGRES_DBNAME="$PAYMENT_POSTGRES_DBNAME" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create configmap notification-config \
            --from-literal=NOTIFICATION_EMAIL_SMTP_HOST="$NOTIFICATION_EMAIL_SMTP_HOST" \
            --from-literal=NOTIFICATION_EMAIL_SMTP_PORT="$NOTIFICATION_EMAIL_SMTP_PORT" \
            --from-literal=NOTIFICATION_EMAIL_FROM_EMAIL="$NOTIFICATION_EMAIL_FROM_EMAIL" \
            --from-literal=NOTIFICATION_EMAIL_FROM_NAME="$NOTIFICATION_EMAIL_FROM_NAME" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Sync Secrets
        env:
          NS: ${{ vars.NS }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          RABBITMQ_DSN: ${{ secrets.RABBITMQ_DSN }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          AUTH_ADMIN_DEFAULT_ADMIN_EMAIL: ${{ secrets.AUTH_ADMIN_DEFAULT_ADMIN_EMAIL }}
          AUTH_ADMIN_DEFAULT_ADMIN_PASSWORD: ${{ secrets.AUTH_ADMIN_DEFAULT_ADMIN_PASSWORD }}
          USER_MEDIA_STORAGE_SIGNER_EMAIL: ${{ secrets.USER_MEDIA_STORAGE_SIGNER_EMAIL }}
          PAYMENT_RAZORPAY_KEY_ID: ${{ secrets.PAYMENT_RAZORPAY_KEY_ID }}
          PAYMENT_RAZORPAY_KEY_SECRET: ${{ secrets.PAYMENT_RAZORPAY_KEY_SECRET }}
          NOTIFICATION_EMAIL_SMTP_USERNAME: ${{ secrets.NOTIFICATION_EMAIL_SMTP_USERNAME }}
          NOTIFICATION_EMAIL_SMTP_PASSWORD: ${{ secrets.NOTIFICATION_EMAIL_SMTP_PASSWORD }}
        run: |
          set -euo pipefail
          
          kubectl -n "$NS" create secret generic common-secret \
            --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
            --from-literal=RABBITMQ_DSN="$RABBITMQ_DSN" \
            --from-literal=JWT_SECRET="$JWT_SECRET_KEY" \
            --from-literal=MONGODB_URI="$MONGODB_URI" \
            --from-literal=REDIS_URL="$REDIS_URL" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create secret generic auth-secret \
            --from-literal=AUTH_ADMIN_DEFAULT_ADMIN_EMAIL="$AUTH_ADMIN_DEFAULT_ADMIN_EMAIL" \
            --from-literal=AUTH_ADMIN_DEFAULT_ADMIN_PASSWORD="$AUTH_ADMIN_DEFAULT_ADMIN_PASSWORD" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create secret generic payment-secret \
            --from-literal=RAZORPAY_KEY_ID="$PAYMENT_RAZORPAY_KEY_ID" \
            --from-literal=RAZORPAY_KEY_SECRET="$PAYMENT_RAZORPAY_KEY_SECRET" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n "$NS" create secret generic notification-secret \
            --from-literal=NOTIFICATION_EMAIL_SMTP_USERNAME="$NOTIFICATION_EMAIL_SMTP_USERNAME" \
            --from-literal=NOTIFICATION_EMAIL_SMTP_PASSWORD="$NOTIFICATION_EMAIL_SMTP_PASSWORD" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Render selected service manifests
        env:
          PROJECT_ID: ${{ vars.PROJECT_ID }}
          REGION: ${{ vars.REGION }}
          REPOSITORY: ${{ vars.REPOSITORY }}
          IMAGE_TAG: ${{ github.event.inputs.image_tag || format('sha-{0}', github.sha) }}
        run: |
          set -euo pipefail
          echo "Using IMAGE_TAG: $IMAGE_TAG"
          
          mkdir -p rendered
          export PROJECT_ID REGION REPOSITORY IMAGE_TAG
          
          for service in ${{ steps.services.outputs.services }}; do
            echo "üìù Rendering $service..."
            
            if [[ -d "deploy/k8s/$service" ]]; then
              find deploy/k8s/$service -type f -name '*.yaml' | while read -r f; do
                out="rendered/${f#deploy/k8s/}"
                mkdir -p "$(dirname "$out")"
                envsubst '${PROJECT_ID} ${REGION} ${REPOSITORY} ${IMAGE_TAG}' < "$f" > "$out"
              done
            fi
          done

      - name: Apply deployments
        run: |
          set -euo pipefail
          kubectl -n ${{ vars.NS }} apply -f rendered/
          
          echo ""
          echo "‚è≥ Waiting for rollouts..."
          for service in ${{ steps.services.outputs.services }}; do
            kubectl -n ${{ vars.NS }} rollout status deployment/qubool-kallyanam-$service --timeout=180s || echo "‚ö†Ô∏è $service timeout"
          done

      - name: Deployment Summary
        if: always()
        run: |
          echo "=== üåç Deployment Summary ==="
          echo "Namespace: ${{ vars.NS }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
      
          echo "=== üöÄ Updated Deployments ==="
          for service in ${{ steps.services.outputs.services }}; do
            echo ""
            echo "üî∏ Service: $service"
            kubectl -n ${{ vars.NS }} get deployment qubool-kallyanam-$service -o wide 2>/dev/null || echo "‚ùå Deployment not found for $service"
            echo ""
            echo "Pods for $service:"
            kubectl -n ${{ vars.NS }} get pods -l app=$service --no-headers 2>/dev/null || echo "‚ùå No pods found for $service"
          done
      
          echo ""
          echo "=== üß© Services Summary ==="
          kubectl -n ${{ vars.NS }} get svc
      
          echo ""
          echo "=== üö™ Ingress Summary ==="
          kubectl -n ${{ vars.NS }} get ingress || echo "No ingress found."
          